@page "/history"
@inject IJSRuntime JS
@inject NavigationManager Nav
@using System.Text.Json

<h2 class="text-center mb-4">üìú Task History</h2>
<p class="text-center text-muted">See all tasks you've completed.</p>

@if (completedTasks == null || !completedTasks.Any())
{
    <div class="text-center mt-4">
        <p>No completed task history yet.</p>
        <a class="btn btn-primary" href="/">Back to Home</a>
    </div>
}
else
{
    <div class="text-center mb-3">
        <button class="btn btn-danger" @onclick="ClearHistory">üóëÔ∏è Clear All History</button>
    </div>

    <div class="container mt-3">
        @foreach (var task in completedTasks)
        {
            <div class="card mb-3 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">@task.Name</h5>
                        <small class="text-muted">
                            Completed on: @task.CompletedDate?.ToString("dddd, dd MMM yyyy ‚Ä¢ hh:mm tt")
                        </small>
                    </div>

                    <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteHistoryItem(task)">
                        Delete
                    </button>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<HistoryTask> completedTasks = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadHistory();
    }

    // Load completed task history
    private async Task LoadHistory()
    {
        var json = await JS.InvokeAsync<string>("localStorage.getItem", "completedHistory");

        completedTasks = string.IsNullOrEmpty(json)
        ? new List<HistoryTask>()
        : JsonSerializer.Deserialize<List<HistoryTask>>(json) ?? new List<HistoryTask>();

        // Sort: latest first
        completedTasks = completedTasks
        .OrderByDescending(t => t.CompletedDate)
        .ToList();
    }

    // Save to localStorage
    private async Task SaveHistory()
    {
        var json = JsonSerializer.Serialize(completedTasks);
        await JS.InvokeVoidAsync("localStorage.setItem", "completedHistory", json);
    }

    // Delete single item
    private async Task DeleteHistoryItem(HistoryTask task)
    {
        completedTasks.Remove(task);
        await SaveHistory();
    }

    // Clear all history
    private async Task ClearHistory()
    {
        completedTasks.Clear();
        await SaveHistory();
    }

    // History Task Model
    public class HistoryTask
    {
        public string Name { get; set; } = "";
        public string Status { get; set; } = "Done";
        public DateTime? CompletedDate { get; set; }
    }
}